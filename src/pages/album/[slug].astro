---
import { getCollection, render } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Hero from "../../components/Hero.astro";
import SeoBlock from "../../components/SeoBlock.astro";
import Pagination from "../../components/Pagination.astro";
import Map from "../../components/Map.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import SocialShare from "../../components/SocialShare.astro";
import { getFlickrAlbumPhotos } from "../../utils/flickr.js";

// 1. Tell Astro which slugs to pre-render.
export async function getStaticPaths() {
  const albums = (await getCollection("albums")).sort(
    (a, b) => a.data.order - b.data.order,
  );

  return albums.map((album, index) => ({
    params: { slug: album.id.replace(/\.md$/, "") },
    props: {
      album,
      prevAlbum: albums[index - 1] ?? null,
      nextAlbum: albums[index + 1] ?? null,
    },
  }));
}

// 2. Destructure props.
const { album, prevAlbum, nextAlbum } = Astro.props;
const {
  title,
  description,
  heroImage,
  flickrAlbumId,
  location,
  lat,
  lng,
  mapZoom,
  tags,
  datePublished,
} = album.data;

const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description: description,
  image: heroImage,
  datePublished: datePublished,
  author: {
    "@type": "Person",
    name: "Timothy Blake",
    url: "https://timothyblake.com",
  },
  ...(tags && tags.length > 0 && { keywords: tags.join(", ") }),
  contentLocation: {
    "@type": "Place",
    name: location,
    geo: {
      "@type": "GeoCoordinates",
      latitude: lat,
      longitude: lng,
    },
  },
};

// 3. Render markdown body to a Content component.
const { Content } = await render(album);

// 4. Fetch photos from Flickr at build time.
let photos: any[] = [];
try {
  photos = await getFlickrAlbumPhotos(flickrAlbumId);
} catch (err) {
  console.warn(`[${title}] Could not fetch Flickr photos:`, err);
}
---

<BaseLayout
  title={title}
  description={description}
  ogImage={heroImage}
  heroImage={heroImage}
  currentId={album.id}
  currentTags={tags}
>
  <script
    slot="head"
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(schema)}
  />
  <main>
    <!-- Hero -->
    <Hero
      title={title}
      description={description}
      heroImage={heroImage}
      location={location}
    />

    <!-- Breadcrumb -->
    <Breadcrumbs
      items={[
        { label: "Home", href: "/" },
        { label: "Destinations", href: "/destinations" },
        { label: title },
      ]}
    />

    <!-- Photo grid -->
    {
      photos.length > 0 ? (
        <section class="py-4" aria-label={`${title} photo gallery`}>
          <div class="container-fluid px-2">
            <div class="row g-1">
              {photos.map((photo, index) => (
                <div class="col-6 col-sm-4 col-md-3 col-xl-2">
                  <a
                    href={photo.url_l}
                    class="photo-thumb glightbox d-block ratio ratio-1x1 border border-dark rounded overflow-hidden position-relative"
                    data-gallery="album-gallery"
                    data-title={
                      photo.title
                        ? `${photo.title} (${index + 1} of ${photos.length})`
                        : `Photo ${index + 1} of ${photos.length}`
                    }
                    aria-label={photo.title || title}
                  >
                    <img
                      src={photo.url_n || photo.url_m}
                      srcset={`${photo.url_n ? photo.url_n + " 320w," : ""} ${photo.url_m ? photo.url_m + " 500w," : ""} ${photo.url_z ? photo.url_z + " 640w" : ""}`}
                      sizes="(max-width: 576px) 50vw, (max-width: 768px) 33vw, (max-width: 992px) 25vw, 16vw"
                      alt={photo.title || `Photo from ${title}`}
                      class="object-fit-cover w-100 h-100"
                      loading="lazy"
                      decoding="async"
                    />
                    <div class="photo-overlay d-flex align-items-center justify-content-center">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="28"
                        height="28"
                        fill="currentColor"
                        class="bi bi-search"
                        viewBox="0 0 16 16"
                      >
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                      </svg>
                    </div>
                  </a>
                </div>
              ))}
            </div>
          </div>
        </section>
      ) : (
        <div class="text-center text-secondary py-5">
          <p class="mb-0">Photos coming soon.</p>
        </div>
      )
    }

    <!-- SEO / long-form text from markdown body -->
    <SeoBlock>
      <Content />
      <hr class="my-3 border-secondary border-opacity-25" />
      <SocialShare title={title} description={description} image={heroImage} />
    </SeoBlock>

    <!-- Location map -->
    <Map lat={lat} lng={lng} zoom={mapZoom} title={title} />

    <!-- Prev / Next navigation -->
    <Pagination
      prevSlug={prevAlbum?.id.replace(/\.md$/, "")}
      prevTitle={prevAlbum?.data.title}
      nextSlug={nextAlbum?.id.replace(/\.md$/, "")}
      nextTitle={nextAlbum?.data.title}
    />
  </main>

  <script>
    import GLightbox from "glightbox";
    import "glightbox/dist/css/glightbox.min.css";

    // Re-initialize GLightbox on every page load AND after every View Transition.
    // Using astro:page-load (fires on both initial load and post-transition) ensures
    // the lightbox works correctly when navigating between album pages.
    function initLightbox() {
      if (!document.querySelector(".glightbox")) return;
      // Destroy any existing instance to prevent duplicate listeners
      if ((window as any).__glightbox) {
        (window as any).__glightbox.destroy();
        (window as any).__glightbox = null;
      }
      (window as any).__glightbox = GLightbox({
        selector: ".glightbox",
        touchNavigation: true,
        loop: true,
      });
    }

    document.addEventListener("astro:page-load", initLightbox);
  </script>

  <style>
    .photo-thumb img {
      transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
    .photo-overlay {
      position: absolute;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      color: var(--accent);
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 1;
    }
    .photo-thumb:hover img {
      transform: scale(1.08); /* slight zoom */
    }
    .photo-thumb:hover .photo-overlay {
      opacity: 1;
    }
  </style>
</BaseLayout>
