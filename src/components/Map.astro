---
interface Props {
  lat: number;
  lng: number;
  title: string;
  zoom?: number;
}

const { lat, lng, title, zoom = 11 } = Astro.props;

// Calculate dynamic bounding box for OpenStreetMap embed
const offset = 1 / Math.pow(2, zoom - 8);
const minLng = lng - offset;
const maxLng = lng + offset;
// Reduce latitude offset slightly for better proportions
const minLat = lat - offset / 2;
const maxLat = lat + offset / 2;
const bbox = `${minLng},${minLat},${maxLng},${maxLat}`;

const embedUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat},${lng}`;

const linkUrl = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=${zoom}/${lat}/${lng}`;
---

<section class="border-top py-4">
  <div class="container">
    <h2 class="ff-display h5 mb-3">Location</h2>

    <!-- Map Facade / Placeholder -->
    <div
      class="map-facade rounded border d-flex flex-column align-items-center justify-content-center bg-dark"
      style="height: 420px; background: rgba(255,255,255,0.03);"
      data-embed={embedUrl}
      data-title={`Map showing the location of ${title}`}
    >
      <button
        class="map-load-btn btn btn-outline-accent px-4 py-2 rounded-pill shadow-sm"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          fill="currentColor"
          class="bi bi-geo-alt-fill me-2"
          viewBox="0 0 16 16"
        >
          <path
            d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10m0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6"
          ></path>
        </svg>
        Load interactive map
      </button>
      <p class="small text-secondary mt-3 mb-0 px-3 text-center">
        Click to load the map from OpenStreetMap
      </p>
    </div>

    <p class="mt-2 mb-0 small text-secondary">
      Map data &copy; <a
        href="https://www.openstreetmap.org/copyright"
        target="_blank"
        rel="noopener noreferrer"
        class="text-accent">OpenStreetMap</a
      > contributors &nbsp;&middot;&nbsp;
      <a
        href={linkUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="text-accent">View larger map &rarr;</a
      >
    </p>
  </div>
</section>

<script>
  function initMapFacades() {
    document.querySelectorAll<HTMLElement>(".map-facade").forEach((facade) => {
      const btn = facade.querySelector(".map-load-btn");
      if (!btn) return;

      btn.addEventListener(
        "click",
        () => {
          const iframe = Object.assign(document.createElement("iframe"), {
            src: facade.dataset.embed,
            loading: "lazy",
            title: facade.dataset.title,
            style: "width:100%;height:420px;border:0;display:block;",
          });
          iframe.setAttribute("allowfullscreen", "");
          facade.replaceWith(iframe);
        },
        { once: true },
      );
    });
  }

  // Run on page load and after every View Transition swap
  document.addEventListener("astro:page-load", initMapFacades);
</script>
