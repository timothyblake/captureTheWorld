---
import { getCollection } from "astro:content";
import { albumThumb } from "../utils/cloudflare";

interface Props {
    currentId?: string;
    currentTags?: string[];
    limit?: number;
    title?: string;
}

const { currentId, currentTags = [], limit = 3, title } = Astro.props;

// Fetch all albums
const allAlbums = await getCollection("albums");

// Score and filter albums
const relatedAlbums = allAlbums
    .filter((album) => !currentId || album.id !== currentId) // Exclude current album if ID exists
    .map((album) => {
        const albumTags = album.data.tags || [];
        const intersection = currentTags.filter((tag) =>
            albumTags.includes(tag),
        );
        return {
            album,
            score: intersection.length,
        };
    })
    .sort((a, b) => {
        // Sort by score (intersection count) descending
        if (b.score !== a.score) {
            return b.score - a.score;
        }
        // Then by order
        return a.album.data.order - b.album.data.order;
    })
    .slice(0, limit)
    .map((item) => item.album);
---

{
    relatedAlbums.length > 0 && (
        <section class="py-5 border-top border-dark" id="related-albums">
            <div class="container-xl">
                <h2 class="ff-display h3 mb-4 text-center">
                    {title ||
                        (currentId
                            ? "Related Destinations"
                            : "Explore Destinations")}
                </h2>
                <div class="row row-cols-1 row-cols-md-3 g-4">
                    {relatedAlbums.map((album) => {
                        const imgUrl =
                            album.data.thumbnail ?? album.data.heroImage;
                        const slug = album.id.replace(/\.md$/, "");
                        return (
                            <div class="col">
                                <a
                                    href={`/album/${slug}`}
                                    class="album-card card h-100 border bg-transparent"
                                    data-astro-prefetch="viewport"
                                >
                                    <div
                                        class="ratio overflow-hidden"
                                        style="--bs-aspect-ratio: 62.5%"
                                    >
                                        <img
                                            src={albumThumb(imgUrl, 500)}
                                            srcset={`${albumThumb(imgUrl, 400)} 400w, ${albumThumb(imgUrl, 800)} 800w`}
                                            sizes="(max-width: 768px) 100vw, 33vw"
                                            alt={album.data.title}
                                            class="object-fit-cover w-100 h-100 card-img"
                                            loading="lazy"
                                            decoding="async"
                                        />
                                    </div>
                                    <div class="card-body d-flex flex-column text-center">
                                        <p class="text-accent small fw-semibold text-uppercase ls-wide mb-1">
                                            {album.data.location}
                                        </p>
                                        <h3 class="ff-display card-title h5 mb-0">
                                            {album.data.title}
                                        </h3>
                                    </div>
                                </a>
                            </div>
                        );
                    })}
                </div>
            </div>
        </section>
    )
}

<style>
    .album-card {
        transition:
            transform 0.25s ease,
            border-color 0.25s ease;
    }
    .album-card:hover {
        transform: translateY(-4px);
        border-color: var(--accent) !important;
    }
    .album-card .card-img {
        transition: transform 0.4s ease;
    }
    .album-card:hover .card-img {
        transform: scale(1.04);
    }
    .ls-wide {
        letter-spacing: 0.1em;
    }
</style>
